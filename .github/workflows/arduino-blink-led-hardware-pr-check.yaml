name: ğŸ§ª Arduino blink LED hardware - PR check

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - edited

permissions:
  contents: read

jobs:
  acceptance_tests:
    name: âœ… Build and Run Acceptance tests
    if: |
      !github.event.repository.is_template &&
      github.head_ref == 'arduino-blink-led-hardware'
    runs-on: self-hosted
    steps:
      - name: ğŸ›¡ï¸ Get GitHub App token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.THEALBERTDEVBOT_APP_ID }}
          private-key: ${{ secrets.THEALBERTDEVBOT_SECRET_KEY }}
          owner: ${{ github.repository_owner }}

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: ğŸ—ï¸ Build and upload PlatformIO CLI project
        run: |
          cd ${{ github.workspace }}/arduino/workspace/blink-led-hardware
          pio run --target upload

      # - name: ğŸ§¬ Run unit tests
      #   env:
      #     CPPUTEST_HOME: /opt/cpputest
      #   run: |
      #     cd ${{ github.workspace }}/.github/tests/unit/test_blink_led_hardware/arduino
      #     make

      - name: ğŸ§¬ Run acceptance tests
        run: |
          cd ${{ github.workspace }}/.github/tests/acceptance/test_blink_led_toggle
          /usr/bin/python3 -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt
          python -m pytest -v
